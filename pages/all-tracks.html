<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Songs</title>
    <link rel="stylesheet" href="../css/all-track_style.css">

</head>

<body>

    <!-- Navbar -->
    <div class="navbar">
        <div class="logo">soundtrackmoods</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="menu">
            <a href="../index.html">Home</a>
            <a href="add-track.html" style="margin-right: 30px;">Add track</a>
        </div>

        <!-- Button to create new playlist -->
        <a id="createPlaylistBtn" class="create-playlist-btn">Create New Playlist</a>

        <!-- Modal for entering playlist name -->
        <div id="playlistModal" class="playlist-modal">
            <div class="playlist-modal-content">
                <h3>Enter Playlist Name</h3>
                <input type="text" id="playlistName" placeholder="Playlist Name">
                <button id="savePlaylistBtn">Save Playlist</button>
                <button id="cancelPlaylistBtn">Cancel</button>
            </div>
        </div>

        <h2>All Songs</h2>
        <ul class="song-list" id="songList">
            <!-- Songs will be dynamically added here -->
        </ul>

        <a id="deletePlaylistBtn" class="delete-playlist-btn">Delete Playlist</a>

    </div>

    <!-- Expanded Player -->
    <div class="player" id="player">
        <div class="cover" id="cover" style="background-image: url('');"></div>
        <div class="song-details">
            <div id="songTitle" class="song-title"></div>
            <div id="songAuthor" class="song-author"></div>
        </div>
        <div class="progress-wrapper" id="progressWrapper">
            <input type="range" id="progressBar" class="progress-bar" value="0" min="0" max="100" step="0.1" />
        </div>
        <div class="controls">
            <button id="prevBtn" class="control-btn">⏮️</button>
            <button id="playPauseBtn" class="control-btn">⏯️</button>
            <button id="nextBtn" class="control-btn">⏭️</button>
        </div>
    </div>

    <script type="module">
        const audioFolderPath = '../audio/';
        let currentAudio = null;
        let currentSongIndex = -1;
        let songs = [];
        let isPlaying = false;

        function getQueryParams() {
            const url = window.location.href;
            const urlParams = new URLSearchParams(window.location.search);
            const tipo = urlParams.get('tipo');
            const author = urlParams.get('author');
            return { tipo, author };
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js"; // Importa Firestore

        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABElssbFMChF1HvJkQY36Kes1kbvIM3UM",
            authDomain: "soundtrackmoods.firebaseapp.com",
            projectId: "soundtrackmoods",
            storageBucket: "soundtrackmoods.appspot.com",
            messagingSenderId: "75386945766",
            appId: "1:75386945766:web:4405cd8dcd7f0de681fb27",
            databaseURL: "https://soundtrackmoods-default-rtdb.firebaseio.com" // Se usi Realtime DB
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Modal per la creazione della playlist
        const createPlaylistBtn = document.getElementById('createPlaylistBtn');
        const playlistModal = document.getElementById('playlistModal');
        const savePlaylistBtn = document.getElementById('savePlaylistBtn');
        const cancelPlaylistBtn = document.getElementById('cancelPlaylistBtn');
        const playlistNameInput = document.getElementById('playlistName');

        // Funzione per aprire il modal
        createPlaylistBtn.addEventListener('click', () => {
            playlistModal.style.display = 'block'; // Mostra il modal
        });

        // Funzione per chiudere il modal
        cancelPlaylistBtn.addEventListener('click', () => {
            playlistModal.style.display = 'none'; // Nascondi il modal
        });


        // Funzione per salvare la playlist
        savePlaylistBtn.addEventListener('click', async () => {
            const playlistName = playlistNameInput.value.trim();

            if (playlistName) {
                try {
                    // Aggiungi la playlist alla collezione "playlists" in Firestore
                    const docRef = await addDoc(collection(db, "playlists"), {
                        name: playlistName,
                        tracks: [] // Playlist inizialmente vuota
                    });

                    console.log("Playlist aggiunta con ID: ", docRef.id);
                    alert('Playlist creata con successo!');

                    // Chiudi il modal dopo aver aggiunto la playlist
                    playlistModal.style.display = 'none';
                    playlistNameInput.value = ''; // Resetta il campo input
                } catch (e) {
                    console.error("Errore nel creare la playlist: ", e);
                    alert('Errore nella creazione della playlist.');
                }
            } else {
                alert('Per favore, inserisci un nome valido per la playlist.');
            }
        });



        import { query, where, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

        // Funzione per recuperare i brani per una playlist specifica
        async function getSongsByPlaylist(playlistName) {
            console.log("Recupero i brani per la playlist:", playlistName);
            const db = getFirestore();

            try {
                // Riferimento alla collezione delle playlist
                const playlistsRef = collection(db, "playlists");

                // Ottieni tutti i documenti della collezione
                const querySnapshot = await getDocs(playlistsRef);

                // Cerca il documento che ha il campo `name` uguale a `playlistName`
                let foundPlaylist = null;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.name === playlistName) {
                        foundPlaylist = data;
                    }
                });

                if (foundPlaylist) {
                    // Se troviamo la playlist, stampiamo i brani nel log
                    if (Array.isArray(foundPlaylist.tracks)) {
                        console.log(foundPlaylist.tracks);

                        foundPlaylist.tracks.forEach((track, index) => {
                            addSongToList(track, index, false);
                        });
                    } else {
                        console.log(`Nessun brano trovato nella playlist: ${playlistName}`);
                    }
                } else {
                    console.log(`La playlist "${playlistName}" non è stata trovata.`);
                }
            } catch (error) {
                console.error("Errore nel recuperare le canzoni:", error);
            }
        }

        async function getAllTracks() {
            console.log("Recupero tutti i brani dalla collezione 'all-tracks'");
            const db = getFirestore();

            try {
                // Riferimento al documento `tracksDocument` nella collezione `all-tracks`
                const tracksDocRef = doc(db, "all-tracks", "tracksDocument");
                const docSnap = await getDoc(tracksDocRef);

                if (docSnap.exists()) {
                    // Ottieni l'array di brani dal documento
                    const data = docSnap.data();
                    const tracks = data.tracks;
                    songs = tracks;

                    if (Array.isArray(tracks) && tracks.length > 0) {
                        // Stampa ogni brano nel log
                        tracks.forEach((track, index) => {
                            addSongToList(track, index, true);
                        });
                    } else {
                        console.log("Nessun brano trovato nella collezione.");
                    }
                } else {
                    console.log("Documento 'tracksDocument' non trovato nella collezione 'all-tracks'.");
                }
            } catch (error) {
                console.error("Errore nel recuperare i brani:", error);
            }
        }

        let params = getQueryParams();

        if (params.tipo === "all-tracks" && !params.author) {
            document.addEventListener('DOMContentLoaded', getAllTracks);
        } else if (!params.author) {
            document.addEventListener('DOMContentLoaded', getSongsByPlaylist(params.tipo));
        } else {
            document.addEventListener('DOMContentLoaded', loadTracksByAuthor(params.author));
        }

        function getMp3Duration(filePath) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                audio.src = filePath;

                // Aspetta che i metadati siano caricati
                audio.addEventListener('loadedmetadata', () => {
                    resolve(audio.duration); // Durata in secondi
                });

                audio.addEventListener('error', (error) => {
                    reject(error); // Gestisci gli errori
                });
            });
        }

        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}m ${remainingSeconds}s`;
        }


        async function addSongToList(song, index, all_track) {
            console.log("all-tracks", all_track);
            const songListElement = document.getElementById('songList');
            const songItem = document.createElement('li');
            songItem.className = 'song-item';

            let info_track;
            let track_duration;
            if (!all_track) {
                info_track = await getInfoTrack(song);

                try {
                    const durationInSeconds = await getMp3Duration(`../audio/${info_track.title}.mp3`);
                    track_duration = formatDuration(durationInSeconds);
                } catch (error) {
                    console.error('Errore nel calcolare la durata:', error);
                    track_duration = 'N/A';
                }
                songItem.innerHTML = `
        <div class="song-info">
            <div class="song-title">${info_track.title}</div>
            <div class="song-author">${info_track.author}</div>
            <div class="song-duration">${track_duration}</div>
        </div>
        <button class="play-button" onclick="playSong(${index})">Play</button>
        <div class="menu-container">
        <button class="menu-button" onclick="toggleMenu(${index})">⋮</button>
        <ul class="menu-options" id="menu-${index}">
            <li onclick="deleteSong(${index})">Delete</li>
            <li onclick="togglePlaylist(${index})">Add/Remove from Playlist</li>
        </ul>
    </div>
    <div id="playlist-section-${index}" class="playlist-section" style="display: none;">
        <h3>Select Playlists</h3>
        <div id="playlist-container-${index}">
            <!-- Le playlist per questo brano verranno caricate qui -->
        </div>
        <button onclick="closePlaylistSection(${index})">Close</button>
    </div>
    `;
            } else {
                try {
                    const durationInSeconds = await getMp3Duration(`../audio/${song.title}.mp3`);
                    track_duration = formatDuration(durationInSeconds);
                } catch (error) {
                    console.error('Errore nel calcolare la durata:', error);
                    track_duration = 'N/A';
                }

                songItem.innerHTML = `
        <div class="song-info">
            <div class="song-title">${song.title}</div>
            <div class="song-author">${song.author}</div>
            <div class="song-duration">${track_duration}</div>
        </div>
        <button class="play-button" onclick="playSong(${index})">Play</button>
        <div class="menu-container">
        <button class="menu-button" onclick="toggleMenu(${index})">⋮</button>
        <ul class="menu-options" id="menu-${index}">
            <li onclick="deleteSong(${index})">Delete</li>
            <li onclick="togglePlaylist(${index})">Add/Remove from Playlist</li>
        </ul>
    </div>
    <div id="playlist-section-${index}" class="playlist-section" style="display: none;">
        <h3>Select Playlists</h3>
        <div id="playlist-container-${index}">
            <!-- Le playlist per questo brano verranno caricate qui -->
        </div>
        <button onclick="closePlaylistSection(${index})">Close</button>
    </div>
    `;
            }
            songListElement.appendChild(songItem);
        }

        window.closePlaylistSection = function closePlaylistSection(index) {
            const playlistSection = document.getElementById(`playlist-section-${index}`);
            playlistSection.style.display = "none"; // Nascondi la sezione
        }

        window.toggleMenu = function toggleMenu(index) {
            const menu = document.getElementById(`menu-${index}`);
            menu.classList.toggle('show');
        }

        window.togglePlaylist = async function togglePlaylist(index) {
            const playlistSection = document.getElementById(`playlist-section-${index}`);

            // Controlla se la sezione della playlist è visibile o no
            if (playlistSection.style.display === "none" || playlistSection.style.display === "") {
                // Se è nascosta, mostralo
                playlistSection.style.display = "block";
                await loadPlaylists(index); // Carica le playlist per questo brano
            } else {
                // Se è visibile, nascondilo
                playlistSection.style.display = "none";
            }
        }

        async function loadPlaylists(index) {
            const db = getFirestore();
            const playlistsRef = collection(db, "playlists");
            const songTitle = songs[index].title; // Ottieni il titolo della canzone selezionata

            try {
                // Recupera tutte le playlist dal database
                const querySnapshot = await getDocs(playlistsRef);

                // Recupera il contenitore della playlist
                const playlistContainer = document.getElementById(`playlist-container-${index}`);
                playlistContainer.innerHTML = ""; // Pulisci il contenitore per la lista di playlist

                // Itera su tutte le playlist
                querySnapshot.forEach(doc => {
                    const playlistData = doc.data();
                    const playlistName = playlistData.name; // Nome della playlist
                    const songsInPlaylist = playlistData.tracks || []; // Brani nella playlist

                    // Verifica se la canzone selezionata è nella playlist
                    const isSongInPlaylist = songsInPlaylist.includes(songTitle);

                    // Crea un elemento per la playlist con una checkbox
                    const playlistItem = document.createElement("div");
                    playlistItem.classList.add("playlist-item");

                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.checked = isSongInPlaylist; // Se la canzone è nella playlist, seleziona la checkbox
                    checkbox.id = `checkbox-${doc.id}-${index}`;

                    // Associa un evento alla checkbox per aggiungere o rimuovere la canzone dalla playlist
                    checkbox.addEventListener("change", () => {
                        if (checkbox.checked) {
                            addSongToPlaylist(songTitle, doc.id); // Aggiungi la canzone alla playlist
                        } else {
                            removeSongFromPlaylist(songTitle, doc.id); // Rimuovi la canzone dalla playlist
                        }
                    });

                    // Aggiungi il nome della playlist e la checkbox all'elemento
                    const playlistLabel = document.createElement("label");
                    playlistLabel.setAttribute("for", checkbox.id);
                    playlistLabel.textContent = playlistName;

                    playlistItem.appendChild(checkbox);
                    playlistItem.appendChild(playlistLabel);

                    // Aggiungi l'elemento della playlist al contenitore
                    playlistContainer.appendChild(playlistItem);
                });

                // Mostra il banner
                const playlistSection = document.getElementById(`playlist-section-${index}`);
                playlistSection.style.display = "block";
            } catch (error) {
                console.error("Errore nel caricare le playlist:", error);
            }
        }

        async function addSongToPlaylist(songTitle, playlistId) {
            const db = getFirestore();
            const playlistRef = doc(db, "playlists", playlistId);

            try {
                await updateDoc(playlistRef, {
                    tracks: arrayUnion(songTitle)
                });
                console.log(`Canzone '${songTitle}' aggiunta alla playlist con ID ${playlistId}.`);
            } catch (error) {
                console.error("Errore nell'aggiungere la canzone alla playlist:", error);
            }
        }

        async function removeSongFromPlaylist(songTitle, playlistId) {
            const db = getFirestore();
            const playlistRef = doc(db, "playlists", playlistId);

            try {
                await updateDoc(playlistRef, {
                    tracks: arrayRemove(songTitle)
                });
                console.log(`Canzone '${songTitle}' rimossa dalla playlist con ID ${playlistId}.`);
            } catch (error) {
                console.error("Errore nel rimuovere la canzone dalla playlist:", error);
            }
        }

        // Nasconde i menu quando si clicca fuori
        document.addEventListener('click', (event) => {
            const isMenuButton = event.target.classList.contains('menu-button');
            if (!isMenuButton) {
                document.querySelectorAll('.menu-options').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        async function getInfoTrack(trackTitle) {
            console.log(`Cerco informazioni per il brano: ${trackTitle}`);
            const db = getFirestore();

            try {
                // Riferimento al documento `tracksDocument` nella collezione `all-tracks`
                const tracksDocRef = doc(db, "all-tracks", "tracksDocument");
                const docSnap = await getDoc(tracksDocRef);

                if (docSnap.exists()) {
                    // Ottieni l'array di brani
                    const data = docSnap.data();
                    const tracks = data.tracks;

                    // Cerca il brano in base al titolo
                    const track = tracks.find((t) => t.title === trackTitle);

                    if (track) {
                        // Crea un array con le informazioni del brano
                        const trackInfo = {
                            title: track.title,
                            author: track.author,
                            cover: track.cover
                        };

                        console.log("Informazioni trovate:", trackInfo);
                        return trackInfo; // Restituisce le informazioni
                    } else {
                        console.log(`Brano "${trackTitle}" non trovato.`);
                        return null; // Restituisce null se il brano non è stato trovato
                    }
                } else {
                    console.log("Documento 'tracksDocument' non trovato nella collezione 'all-tracks'.");
                    return null; // Restituisce null se il documento non esiste
                }
            } catch (error) {
                console.error("Errore nel recuperare il brano:", error);
                return null; // Restituisce null in caso di errore
            }
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            if (currentAudio) {
                progressBar.value = (currentAudio.currentTime / currentAudio.duration) * 100;
            }
        }

        // Cambia la posizione della traccia quando l'utente sposta il cursore
        function seekAudio(event) {
            if (currentAudio) {
                const progressBar = event.target;
                const newTime = (progressBar.value / 100) * currentAudio.duration;
                currentAudio.currentTime = newTime;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('progressBar').addEventListener('input', seekAudio);
        });

        if (currentAudio) {
            currentAudio.ontimeupdate = updateProgressBar;
        }

        // Funzione per riprodurre la canzone
        window.playSong = function playSong(index) {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
            }

            currentSongIndex = index;


            const song = songs[currentSongIndex];

            if (!currentAudio) {
                currentAudio = new Audio(audioFolderPath + song.title + ".mp3");
            } else {
                currentAudio.src = audioFolderPath + song.title + ".mp3";
                currentAudio.currentTime = 0;
            }

            currentAudio.ontimeupdate = updateProgressBar;
            currentAudio.onended = nextSong;

            currentAudio.play();

            // Aggiorna il titolo e l'autore

            document.getElementById('songTitle').textContent = song.title;
            document.getElementById('songAuthor').textContent = song.author;

            // Aggiorna l'interfaccia
            document.getElementById('cover').style.backgroundImage = `url(${audioFolderPath}${song.cover})`;
            document.getElementById('playPauseBtn').innerText = 'Pause';

            // Mostra il player
            const player = document.getElementById('player');
            player.classList.add('show');
        }

        function savePlayerState() {
            const playerState = {
                songIndex: currentSongIndex,
                isPlaying: !currentAudio.paused,
                currentTime: currentAudio.currentTime,
                songTitle: songs[currentSongIndex]?.title,
                songCover: songs[currentSongIndex]?.cover
            };
            sessionStorage.setItem('playerState', JSON.stringify(playerState));
        }

        // Funzione per ripristinare lo stato del player
        function restorePlayerState(playerState) {

            currentSongIndex = playerState.songIndex;
            const song = songs[currentSongIndex];

            // Se l'oggetto audio non è ancora stato creato, lo creiamo
            if (!currentAudio) {
                currentAudio = new Audio(audioFolderPath + song.filename);
            } else {
                // Se già esiste, aggiorniamo il file e il tempo
                currentAudio.src = audioFolderPath + song.filename;
            }

            currentAudio.currentTime = playerState.currentTime;

            if (playerState.isPlaying) {
                currentAudio.play();
                document.getElementById('playPauseBtn').innerText = 'Pause';
            } else {
                currentAudio.pause();
                document.getElementById('playPauseBtn').innerText = 'Play';
            }

            // Aggiorna l'interfaccia del player
            document.getElementById('cover').style.backgroundImage = `url(${audioFolderPath}${song.cover})`;
            document.getElementById('player').classList.add('show');

        }

        let isPlayerMaximazed = false;

        // Play/Pause toggle
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('playPauseBtn').onclick = function (event) {
                event.stopPropagation(); // Impedisce la propagazione al player
                if (currentAudio.paused) {
                    currentAudio.play();
                    this.innerText = 'Pause';
                    savePlayerState(); // Salva lo stato ogni volta che cambia
                } else {
                    currentAudio.pause();
                    this.innerText = 'Play';
                    savePlayerState(); // Salva lo stato ogni volta che cambia
                }
            };

            // Go to the next song
            document.getElementById('nextBtn').onclick = function (event) {
                event.stopPropagation(); // Impedisce la propagazione al player
                nextSong();
            };

            // Go to the previous song
            document.getElementById('prevBtn').onclick = function (event) {
                event.stopPropagation(); // Impedisce la propagazione al player
                prevSong();
            };

            // Toggle player expansion
            document.getElementById('player').onclick = function () {
                const player = document.getElementById('player');
                const cover = document.getElementById('cover');
                player.classList.toggle('expanded');
                isPlayerMaximazed = !isPlayerMaximazed;
                if (isPlayerMaximazed) {
                    document.getElementById('cover').style.display = "block";
                } else {
                    document.getElementById('cover').style.display = "none";
                }
            };
        });

        function nextSong() {
            if (currentSongIndex < songs.length - 1) {
                currentSongIndex++;
            } else {
                currentSongIndex = 0;
            }
            playSong(currentSongIndex);
        }

        function prevSong() {
            if (currentSongIndex > 0) {
                currentSongIndex--;
            } else {
                currentSongIndex = songs.length - 1;
            }
            playSong(currentSongIndex);
        }

        // Salva lo stato prima che la pagina venga cambiata
        window.addEventListener('beforeunload', function () {
            savePlayerState(); // Salva lo stato prima che la pagina venga cambiata
        });


        import { updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

        async function deleteSongFromDB(songTitle) {
            const db = getFirestore();
            const tracksDocRef = doc(db, "all-tracks", "tracksDocument");

            try {
                // Recupera il documento per ottenere l'array 'tracks'
                const docSnapshot = await getDoc(tracksDocRef);

                if (!docSnapshot.exists()) {
                    console.error("Il documento non esiste");
                    return;
                }

                const tracks = docSnapshot.data().tracks;

                // Trova l'indice della canzone da rimuovere in base al titolo
                const songIndex = tracks.findIndex(song => song.title === songTitle);

                if (songIndex === -1) {
                    console.log(`La canzone '${songTitle}' non è stata trovata`);
                    alert(`La canzone '${songTitle}' non è stata trovata nel database.`);
                    return;
                }

                // Rimuovi la canzone trovata
                const songToRemove = tracks[songIndex];

                await updateDoc(tracksDocRef, {
                    tracks: arrayRemove(songToRemove) // Rimuove l'oggetto canzone completo
                });

                console.log(`Canzone '${songTitle}' eliminata dal database`);
                alert(`La canzone '${songTitle}' è stata eliminata con successo!`);
            } catch (error) {
                console.error("Errore nell'eliminare la canzone dal database: ", error);
                alert("Si è verificato un errore nell'eliminazione della canzone.");
            }
        }

        window.deleteSong = function deleteSong(index) {
            const songListElement = document.getElementById('songList');
            const songItems = songListElement.getElementsByClassName('song-item');

            if (songItems[index]) {
                // Recupera il titolo del brano da eliminare
                const songTitle = songs[index].title;

                // Elimina la canzone dalla lista dell'interfaccia utente
                songListElement.removeChild(songItems[index]);

                // Elimina la canzone dal database
                deleteSongFromDB(songTitle);

                console.log(`Canzone con indice ${index} eliminata`);
            }
        }



        async function toggleSongInPlaylist(songId, songTitle) {
            const db = getFirestore();

            try {
                // Recupera tutte le playlist
                const playlistsSnapshot = await getDocs(collection(db, "playlists"));

                const playlists = playlistsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Apre un prompt per selezionare la playlist
                const playlistSelection = promptPlaylistSelection(playlists, songId);

                if (playlistSelection) {
                    // Aggiungi o rimuovi la canzone dalla playlist
                    await updatePlaylist(songId, playlistSelection);
                }
            } catch (error) {
                console.error("Errore durante l'aggiunta o rimozione dalla playlist: ", error);
            }
        }

        // Funzione che mostra le playlist con checkbox e permette di selezionare
        function promptPlaylistSelection(playlists, songId) {
            const selectedPlaylists = [];

            playlists.forEach(playlist => {
                const isSongInPlaylist = playlist.songs.includes(songId);

                // Crea una checkbox per ogni playlist
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.checked = isSongInPlaylist;
                checkbox.id = playlist.id;
                checkbox.addEventListener("change", () => {
                    if (checkbox.checked) {
                        selectedPlaylists.push(playlist.id);
                    } else {
                        const index = selectedPlaylists.indexOf(playlist.id);
                        if (index > -1) {
                            selectedPlaylists.splice(index, 1);
                        }
                    }
                });

                // Aggiungi al DOM
                const label = document.createElement("label");
                label.innerText = playlist.name;
                label.appendChild(checkbox);

                // Aggiungi la label e checkbox all'elemento DOM appropriato (ad esempio una finestra modale)
                document.getElementById('playlist-container').appendChild(label);
            });

            // Restituisci l'array delle playlist selezionate
            return selectedPlaylists;
        }

        // Funzione per aggiornare la playlist
        async function updatePlaylist(songId, playlistIds) {
            const db = getFirestore();

            // Per ogni playlist selezionata, aggiungi o rimuovi la canzone
            for (const playlistId of playlistIds) {
                const playlistRef = doc(db, "playlists", playlistId);

                const playlistSnapshot = await getDoc(playlistRef);
                const playlist = playlistSnapshot.data();

                // Se il brano non è già nella playlist, aggiungilo, altrimenti rimuovilo
                if (playlist.songs.includes(songId)) {
                    await updateDoc(playlistRef, {
                        songs: arrayRemove(songId)
                    });
                    console.log(`Rimosso '${songId}' dalla playlist '${playlistId}'`);
                } else {
                    await updateDoc(playlistRef, {
                        songs: arrayUnion(songId)
                    });
                    console.log(`Aggiunto '${songId}' alla playlist '${playlistId}'`);
                }
            }
        }

        async function deletePlaylist() {
            const db = getFirestore();
            const playlistsRef = collection(db, "playlists");
            let params = getQueryParams();
            try {
                // Chiedi all'utente quale playlist eliminare
                const playlistName = params.tipo;

                // Trova la playlist nel database
                const querySnapshot = await getDocs(playlistsRef);
                let playlistToDelete = null;

                querySnapshot.forEach(doc => {
                    const playlistData = doc.data();
                    if (playlistData.name === playlistName) {
                        playlistToDelete = doc.id; // Salva l'ID della playlist
                    }
                });

                if (!playlistToDelete) {
                    alert("Playlist not found.");
                    return;
                }

                // Elimina la playlist
                await deleteDoc(doc(db, "playlists", playlistToDelete));
                alert(`Playlist "${playlistName}" has been deleted.`);
                window.location.href = "../index.html"
            } catch (error) {
                console.error("Error deleting playlist:", error);
                alert("An error occurred while deleting the playlist.");
            }
        }

        document.getElementById("deletePlaylistBtn").addEventListener("click", deletePlaylist);

        function checkTextOverflow() {
            const songItems = document.querySelectorAll('.song-info');
            console.log(songItems);
            songItems.forEach(item => {
                const title = item.querySelector('.song-title');
                const author = item.querySelector('.song-author');

                // Verifica se il titolo è troppo largo
                console.log("Scrollwidth", title.scrollWidth);
                console.log("offsetWidth", title.offsetWidth);
                if (title.scrollWidth > title.offsetWidth) {

                    title.classList.add('scroll-text'); // Aggiunge l'animazione
                } else {
                    title.classList.remove('scroll-text'); // Rimuove l'animazione se non è necessario
                }

                // Verifica se l'autore è troppo largo
                if (author.scrollWidth > author.offsetWidth) {
                    console.log("CIAO");

                    author.classList.add('scroll-text'); // Aggiunge l'animazione
                } else {
                    author.classList.remove('scroll-text'); // Rimuove l'animazione se non è necessario
                }
            });
        }

        window.onload = function () {
            setTimeout(checkTextOverflow, 1000); // Attendi 100 ms per essere sicuri che gli elementi siano nel DOM
        };

        // Riprova ogni volta che la finestra viene ridimensionata
        window.onresize = checkTextOverflow;



        async function loadTracksByAuthor(author) {
            console.log("cds", author);
            const db = getFirestore(); // Recupera l'istanza di Firestore
            const tracksDocRef = doc(db, "all-tracks", "tracksDocument"); // Riferimento al documento tracksDocument

            try {
                // Recupera il documento contenente i brani
                const docSnap = await getDoc(tracksDocRef);

                if (docSnap.exists()) {
                    // Ottieni l'array di brani dal documento
                    const data = docSnap.data();
                    const tracks = data.tracks;
                    songs = tracks;
                    console.log(songs[0].author);
                    const filteredTracks = songs.filter(track => track.author === author);

                    console.log(filteredTracks);

                    if (Array.isArray(tracks) && tracks.length > 0) {
                        // Stampa ogni brano nel log
                        filteredTracks.forEach((track, index) => {
                            addSongToList(track, index, true);
                        });
                    } else {
                        console.log("Nessun brano trovato nella collezione.");
                    }
                } else {
                    console.log("Documento 'tracksDocument' non trovato nella collezione 'all-tracks'.");
                }



            } catch (error) {
                console.error("Errore nel caricare i brani dell'autore:", error);
            }
        }
    </script>
</body>

</html>